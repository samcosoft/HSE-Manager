@page "/permit"
@using Samco_HSE.HSEData
@using FilterType = Syncfusion.Blazor.Grids.FilterType
@using Syncfusion.Blazor.Buttons

@attribute [Authorize(Roles = "Owner,Admin,Supervisor,Officer")]

<PageTitle>مجوز کار ایمن</PageTitle>

<MudCard>
    <MudCardHeader>
        <MudPaper Elevation="3" Width="100%" Class="pa-3">
            <MudGrid>
                <MudItem>
                    <MudText Typo="Typo.h5">مجوز کار ایمن</MudText>
                </MudItem>
                @* <MudItem> *@
                @*     <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled"> *@
                @*         <MudButton StartIcon="fas fa-hat" IconColor="Color.Warning">تحویل تجهیزات</MudButton> *@
                @*         <MudButton StartIcon="fas fa-info" IconColor="Color.Error">نمایش جزئیات</MudButton> *@
                @*     </MudButtonGroup> *@
                @* </MudItem> *@
            </MudGrid>
        </MudPaper>
    </MudCardHeader>
    <MudCardContent>
        <SfGrid @ref="PermitGrid" ID="permitGrid" DataSource="@PermitsList" AllowPaging="true" AllowSorting="true" AllowFiltering="true" EnableStickyHeader="true"
                AllowGrouping="true" Toolbar="@(new[] { "Add", "Edit", "Delete", "Excel Export", "Search", "ColumnChooser" })" ClipMode="ClipMode.EllipsisWithTooltip"
                AllowResizing="true" ShowColumnChooser="true" EnableAdaptiveUI="true" AdaptiveUIMode="AdaptiveMode.Mobile"
                AllowExcelExport="true" Width="100%">
            <GridEvents TValue="Permit" OnActionBegin="PermitGrid_Action"
                        OnToolbarClick="PermitToolbarClickHandler" RowDataBound="Customize_Row"/>
            <GridFilterSettings Type="FilterType.Excel"/>
            <GridColumns>
                <GridColumn HeaderText="ردیف" Field="Oid" IsIdentity="true" IsPrimaryKey="true" Visible="false"/>
                <GridColumn HeaderText="دکل / دفتر" Field="RigNo.Name" AutoFit="true"/>
                <GridColumn Field="WorkID.WellNo.Name" HeaderText="نام چاه" AutoFit="true"/>
                <GridColumn HeaderText="شماره سریال" Field="@nameof(Permit.ArchiveNo)" AutoFit="true"/>
                <GridColumn Field="@nameof(Permit.StartTime)" HeaderText="تاریخ شروع" Format="yyyy/MM/dd"/>
                <GridColumn Field="@nameof(Permit.StartTime)" HeaderText="ساعت شروع" Format="hh:mm tt" AutoFit="true"/>
                <GridColumn Field="@nameof(Permit.EndTime)" HeaderText="تاریخ پایان" Format="yyyy/MM/dd"/>
                <GridColumn Field="@nameof(Permit.EndTime)" HeaderText="ساعت پایان" Format="hh:mm tt" AutoFit="true"/>
                <GridColumn Field="@nameof(Permit.PermitType)" HeaderText="نوع کار" AutoFit="true"/>
                <GridColumn Field="@nameof(Permit.Location)" HeaderText="محل" AutoFit="true"/>
                <GridColumn Field="@nameof(Permit.Description)" HeaderText="شرح کار" AutoFit="true"/>
                <GridColumn Field="Holder.PersonnelName" HeaderText="دریافت کننده" AutoFit="true" MinWidth="100"/>
                <GridColumn Field="Responsible.PersonnelName" HeaderText="مسئول کار" AutoFit="true" MinWidth="100"/>
                <GridColumn Field="Approver.PersonnelName" HeaderText="تأیید کننده" AutoFit="true" MinWidth="100"/>
                <GridColumn HeaderText="بسته شده" AutoFit="true" MinWidth="100">
                    <Template>
                        @{
                            var itm = context as Permit;
                            var isChecked = itm.EndTime != null;
                            <SfCheckBox @bind-Checked="@isChecked"/>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="Agent.PersonnelName" HeaderText="کارشناس ایمنی" AutoFit="true" MinWidth="100"/>
            </GridColumns>
            <GridEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" AllowEditOnDblClick="true" Mode="EditMode.Dialog"
                              ShowDeleteConfirmDialog="true" Dialog="@SamcoSoftShared.GeneralGridEditOption">
                <Validator>
                    <DataAnnotationsValidator/>
                </Validator>
                <Template Context="editFormContext">
                    @{
                        var permit = editFormContext as Permit;
                    }
                    <MudRTLProvider RightToLeft="true">
                        <MudGrid>
                            <MudItem md="4" sm="12">
                                <MudField Label="دکل / دفتر:" Underline="false">
                                    <SamcoRigSelector @bind-SelectedRig="_selRig" DataSource="Rigs"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTextField Label="شماره سریال:" @bind-Value="@(permit.ArchiveNo)" Placeholder="الزامی"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="تاریخ شروع:" Underline="false">
                                    <SamcoDateSelector @bind-DateNotNull="@permit.StartTime" DefaultCalendar="SamcoDateSelector.CalendarType.Persian"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTimePicker @bind-Time="@_startTime" Label="ساعت شروع"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="تاریخ پایان:" Underline="false">
                                    <SamcoDateSelector @bind-Date="@permit.EndTime" DefaultCalendar="SamcoDateSelector.CalendarType.Persian"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTimePicker @bind-Time="@_endTime" Label="ساعت پایان"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="نوع کار:" Underline="false">
                                    <SfComboBox TItem="string" TValue="string" Placeholder="الزامی" AllowFiltering="true"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                DataSource="@_permitType" @bind-Value="@permit.PermitType">
                                    </SfComboBox>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="محل:" Underline="false">
                                    <SfComboBox TItem="string" TValue="string" Placeholder="الزامی" AllowFiltering="true"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                DataSource="@_location" @bind-Value="@permit.Location">
                                    </SfComboBox>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTextField Label="شرح کار:" @bind-Value="@(permit.Description)" Placeholder="الزامی"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="دریافت کننده:" Underline="false">
                                    <SamcoPersonnelSelector DataSource="PersonnelList" @bind-SelectedPersonnel="@permit.Holder" Session="Session1"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="مسئول کار:" Underline="false">
                                    <SamcoPersonnelSelector DataSource="PersonnelList" @bind-SelectedPersonnel="@permit.Responsible" Session="Session1"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="تأیید کننده:" Underline="false">
                                    <SamcoPersonnelSelector DataSource="PersonnelList" @bind-SelectedPersonnel="@permit.Approver" Session="Session1"/>
                                </MudField>
                            </MudItem>
                        </MudGrid>
                    </MudRTLProvider>
                </Template>
            </GridEditSettings>
        </SfGrid>
    </MudCardContent>
</MudCard>