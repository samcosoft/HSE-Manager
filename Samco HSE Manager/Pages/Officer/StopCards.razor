@page "/stopcard"
@using Samco_HSE.HSEData
@using AggregateType = Syncfusion.Blazor.Grids.AggregateType
@using FilterType = Syncfusion.Blazor.Grids.FilterType
@using Syncfusion.Blazor.Popups
@attribute [Authorize(Roles = "Owner,Admin,Supervisor,Officer")]

<PageTitle>گزارش اعمال / شرایط ایمن و نا ایمن</PageTitle>

<MudCard>
    <MudCardHeader>
        <MudPaper Elevation="3" Width="100%" Class="pa-3">
            <MudGrid>
                <MudItem>
                    <MudText Typo="Typo.h5">گزارش اعمال / شرایط ایمن و نا ایمن</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudCardHeader>
    <MudCardContent>
        <SfGrid @ref="StopGrid" ID="stopGrid" DataSource="@StopsList" AllowPaging="true" AllowSorting="true" AllowFiltering="true" EnableStickyHeader="true"
                AllowGrouping="true" Toolbar="@(new[] { "Add", "Edit", "Delete", "Excel Export", "Search", "ColumnChooser" })" ClipMode="ClipMode.EllipsisWithTooltip"
                AllowResizing="true" ShowColumnChooser="true" EnableAdaptiveUI="true" AdaptiveUIMode="AdaptiveMode.Mobile"
                AllowExcelExport="true" Width="100%">
            <GridEvents TValue="StopCard" OnActionBegin="StopGrid_Action"
                        OnToolbarClick="StopToolbarClickHandler" RowDataBound="Customize_Row"/>
            <GridFilterSettings Type="FilterType.Excel"/>
            <GridColumns>
                <GridColumn HeaderText="ردیف" Field="Oid" IsIdentity="true" IsPrimaryKey="true" Visible="false"/>
                <GridColumn HeaderText="دکل / دفتر" Field="WorkID.RigNo.Name" AutoFit="true"/>
                <GridColumn HeaderText="نام چاه" Field="WorkID.WellNo.Name" AutoFit="true"/>
                <GridColumn Field="ReportDate" HeaderText="تاریخ گزارش" AutoFit="true" MinWidth="180"/>
                <GridColumn Field="Reporter.PersonnelName" HeaderText="گزارش دهنده" AutoFit="true" MinWidth="100"/>
                <GridColumn Field="Location" HeaderText="محل مشاهده" AutoFit="true" MinWidth="200"/>
                <GridColumn Field="Category" HeaderText="دسته بندی" AutoFit="true" MinWidth="400"/>
                <GridColumn Field="Observation" HeaderText="مشاهدات" AutoFit="true" MinWidth="400"/>
                <GridColumn Field="Responsible" HeaderText="مسئول پیگیری" AutoFit="true" MinWidth="200"/>
                <GridColumn Field="Severity" HeaderText="درجه خطر" AutoFit="true" MinWidth="100"/>
                <GridColumn Field="@nameof(StopCard.Probablety)" HeaderText="احتمال وقوع" AutoFit="true" MinWidth="100"/>
                <GridColumn HeaderText="ریسک" MinWidth="70" AutoFit="true">
                    <Template>
                        @{
                            var card = context as StopCard;
                            var sever = _stopRisk.ToList().IndexOf(card.Severity) + 1;
                            var prob = _stopProb.ToList().IndexOf(card.Probablety) + 1;
                            var result = (sever * prob) switch
                            {
                                >= 16 => "High",
                                >= 9 => "Medium",
                                _ => "Low"
                                };
                            <MudText Typo="Typo.body1">@result</MudText>
                        }
                    </Template>
                </GridColumn>
                <GridColumn Field="Actions" HeaderText="اقدامات اصلاحی" AutoFit="true" MinWidth="400"/>
                <GridColumn Field="@nameof(StopCard.Efficiency)" HeaderText="اثر بخشی اقدامات اصلاحی" AutoFit="true" MinWidth="400"/>
                <GridColumn Field="Status" HeaderText="وضعیت" AutoFit="true" MinWidth="100"/>
                <GridColumn Field="Comments" HeaderText="توضیحات" AutoFit="true" MinWidth="300"/>
                <GridColumn Field="IsApproved" HeaderText="تأیید شده" DisplayAsCheckBox="true" MinWidth="100"/>
                <GridColumn HeaderText="امتیاز" AutoFit="true" MinWidth="150">
                    <Template>
                        <MudRating SelectedValue="@(((StopCard)context).Score)" Disabled="true" MaxValue="5" Class="d-inline-block"/>
                    </Template>
                </GridColumn>
                <GridColumn HeaderText="تصاویر" AllowSorting="false" AutoFit="true" Width="100">
                    <Template>
                        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="() => ShowImages(((StopCard)context).Oid)">نمایش</MudButton>
                    </Template>
                </GridColumn>
                <GridColumn Field="Agent.PersonnelName" HeaderText="کارشناس ایمنی" AutoFit="true" MinWidth="100"/>
            </GridColumns>
            <GridEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" AllowEditOnDblClick="true" Mode="EditMode.Dialog"
                              ShowDeleteConfirmDialog="true" Dialog="@SamcoSoftShared.GeneralGridEditOption">
                <Validator>
                    <DataAnnotationsValidator/>
                </Validator>
                <Template Context="editFormContext">
                    @{
                        var stopCard = editFormContext as StopCard;
                    }
                    <MudRTLProvider RightToLeft="true">
                        <MudGrid>
                            <MudItem md="4" sm="12">
                                <MudField Label="دکل / دفتر:" DisableUnderLine="true">
                                    <SamcoRigSelector DataSource="Rigs" SelectedRig="_selRig"
                                                      SelectedRigChanged="RigChanged"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="تاریخ گزارش:" DisableUnderLine="true">
                                    <SamcoDateSelector @bind-Date="@stopCard.ReportDate" DefaultCalendar="SamcoDateSelector.CalendarType.Persian"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="گزارش دهنده:" DisableUnderLine="true">
                                    <SamcoPersonnelSelector DataSource="@PersonnelList" @bind-SelectedPersonnel="@stopCard.Reporter" Session="Session1"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="محل مشاهده:" DisableUnderLine="true">
                                    <SfComboBox TItem="string" TValue="string" DataSource="_location" @bind-Value="@stopCard.Location"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" Placeholder="الزامی"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="دسته بندی:" DisableUnderLine="true">
                                    <SfComboBox TItem="string" TValue="string" DataSource="_category" @bind-Value="@stopCard.Category"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" Placeholder="الزامی"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTextField T="string" @bind-Value="@stopCard.Observation" Label="مشاهدات:" Placeholder="الزامی" Lines="3"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="مسئول پیگیری:" DisableUnderLine="true">
                                    <SfComboBox TItem="string" TValue="string" DataSource="RigRoles" @bind-Value="@stopCard.Responsible"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="درجه خطر:" DisableUnderLine="true">
                                    <SfComboBox TItem="string" TValue="string" DataSource="_stopRisk" @bind-Value="@stopCard.Severity"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="احتمال وقوع:" DisableUnderLine="true">
                                    <SfComboBox TItem="string" TValue="string" DataSource="_stopProb" @bind-Value="@stopCard.Probablety"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTextField T="string" @bind-Value="@stopCard.Actions" Label="اقدامات اصلاحی:" Lines="3"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTextField T="string" @bind-Value="@stopCard.Efficiency" Label="اثر بخشی اقدامات اصلاحی:" Lines="3"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="وضعیت:" DisableUnderLine="true">
                                    <SfComboBox TItem="string" TValue="string" DataSource="_status" @bind-Value="@stopCard.Status"
                                                FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"/>
                                </MudField>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudTextField T="string" @bind-Value="@stopCard.Comments" Label="توضیحات:"/>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudCheckBox @bind-Checked="@stopCard.IsApproved">تأیید شده</MudCheckBox>
                            </MudItem>
                            <MudItem md="4" sm="12">
                                <MudField Label="امتیاز ایمنی:" DisableUnderLine="true">
                                    <MudRating @bind-SelectedValue="@stopCard.Score" MaxValue="5"/>
                                </MudField>
                            </MudItem>
                            @{
                                if (stopCard.Oid >= 0 && _photoList != null)
                                {
                                    <MudItem md="4" sm="12">
                                        <MudField Label="تصاویر ضمیمه:" DisableUnderLine="true">
                                            <MudButton Color="Color.Info" OnClick="() => _photoShowVisible = true"
                                                       Variant="Variant.Filled">
                                                نمایش
                                            </MudButton>
                                        </MudField>
                                    </MudItem>
                                }
                            }
                        </MudGrid>
                    </MudRTLProvider>
                </Template>
            </GridEditSettings>
            <GridAggregates>
                <GridAggregate>
                    <GridAggregateColumns>
                        <GridAggregateColumn Field="@nameof(StopCard.ReportDate)" Type="AggregateType.Count">
                            <FooterTemplate>
                                @{
                                    var aggregate = context as AggregateTemplateContext;
                                    <MudText Typo="Typo.body1">@aggregate.Count</MudText>
                                }
                            </FooterTemplate>
                        </GridAggregateColumn>
                    </GridAggregateColumns>
                </GridAggregate>
            </GridAggregates>
        </SfGrid>
    </MudCardContent>
</MudCard>

<SfDialog @bind-Visible="@_photoShowVisible" Header="تصاویر" Width="500" CloseOnEscape="true">
    <DialogTemplates>
        <Content>
            <MudCarousel ItemsSource="@_photoList" AutoCycle="true" AutoCycleTime="TimeSpan.FromSeconds(10)">
                <ItemTemplate>
                    <MudImage Src="@context" Elevation="2"/>
                </ItemTemplate>
            </MudCarousel>
        </Content>
        <FooterTemplate>
            <MudButton Color="Color.Error" OnClick="@(() => _photoShowVisible = false)">بستن</MudButton>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>