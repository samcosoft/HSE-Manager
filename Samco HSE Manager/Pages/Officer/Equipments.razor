@page "/equipment"
@attribute [Authorize(Roles = "Owner,Admin,Supervisor,Officer")]
@using Samco_HSE.HSEData
@using FilterType = Syncfusion.Blazor.Grids.FilterType

<PageTitle>مدیریت تجهیزات حفاظت فردی</PageTitle>

<MudCard>
    <MudCardHeader>
        <MudPaper Elevation="3" Width="100%" Class="pa-3">
            <MudGrid>
                <MudItem>
                    <MudText Typo="Typo.h5">مدیریت تجهیزات حفاظت فردی</MudText>
                </MudItem>
                <MudItem>
                    <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                        <MudButton StartIcon="fas fa-input-numeric" IconColor="Color.Error" OnClick="OnSetNumberBtnClick">تنظیم موجودی</MudButton>
                        <MudButton StartIcon="fas fa-hand-holding-box" IconColor="Color.Warning" OnClick="OnDistributeBtnClick">توزیع تجهیزات</MudButton>
                    </MudButtonGroup>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudCardHeader>
    <MudCardContent>
        <SfGrid @ref="EquipmentGrid" ID="equipGrid" DataSource="@EquipmentsList" AllowPaging="true" AllowSorting="true" AllowFiltering="true" EnableStickyHeader="true"
                AllowGrouping="true" Toolbar="@(new[] { "Add", "Edit", "Delete", "Excel Export", "Search", "ColumnChooser" })" ClipMode="ClipMode.EllipsisWithTooltip"
                AllowResizing="true" ShowColumnChooser="true" EnableAdaptiveUI="true" AdaptiveUIMode="AdaptiveMode.Mobile"
                AllowExcelExport="true" Width="100%">
            <GridEvents TValue="Equipment" OnActionBegin="EquipGrid_Action"
                        OnToolbarClick="EquipToolbarClickHandler"/>
            <GridFilterSettings Type="FilterType.Excel"/>
            <GridColumns>
                <GridColumn HeaderText="ردیف" Field="Oid" IsPrimaryKey="true" Visible="false"/>
                <GridColumn HeaderText="نام تجهیز" Field="Name" AutoFit="true"/>
                <GridColumn HeaderText="واحد شمارش" Field="CountUnit" AutoFit="true"/>
                <GridColumn HeaderText="مدل" Field="Model" AutoFit="true"/>
                <GridColumn HeaderText="نوع تجهیز" Field="@nameof(Equipment.EquipType)" AutoFit="true"/>
                @{
                    if (Rigs != null)
                    {
                        foreach (var rig in Rigs)
                        {
                            <GridColumn HeaderText="@($"تعداد در {rig.Name}")" AutoFit="true">
                                <Template>
                                    @{
                                        var itm = context as Equipment;
                                        @EquipmentGridUnbound(rig.Oid, itm)
                                    }
                                </Template>
                            </GridColumn>
                        }
                    }
                }
            </GridColumns>
            <GridEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" AllowEditOnDblClick="true" Mode="EditMode.Dialog"
                              ShowDeleteConfirmDialog="true" Dialog="@SamcoSoftShared.GeneralGridEditOption">
                <Validator>
                    <DataAnnotationsValidator/>
                </Validator>
                <Template Context="editFormContext">
                    @{
                        var equipment = (Equipment)editFormContext;
                    }
                    <MudRTLProvider RightToLeft="true">
                        <MudGrid>
                            <MudItem md="6" sm="12">
                                <MudTextField Label="نام تجهیز:" @bind-Value="@equipment.Name" Placeholder="الزامی"
                                              Adornment="Adornment.Start" AutoFocus="true"/>
                            </MudItem>
                            <MudItem md="6" sm="12">
                                <MudTextField Label="مدل:" @bind-Value="@equipment.Model"
                                              Adornment="Adornment.Start"/>
                            </MudItem>
                            <MudItem md="6" sm="12">
                                <MudTextField Label="واحد شمارش:" @bind-Value="@equipment.CountUnit"
                                              Adornment="Adornment.Start"/>
                            </MudItem>
                            <MudItem md="6" sm="12">
                                <MudField Label="نوع تجهیز:" Underline="false">
                                    <SfComboBox TValue="string" TItem="string" DataSource="@_ppeKind" Placeholder="الزامی"
                                                @bind-Value="@equipment.EquipType" AllowFiltering="true">
                                    </SfComboBox>
                                </MudField>
                            </MudItem>
                            <MudItem md="6" sm="12">
                                <MudField Label="استفاده کنندگان:" Underline="false">
                                    <SfMultiSelect TItem="string" TValue="string[]" DataSource="@RigRoles"
                                                   @bind-Value="@Consumers" Placeholder="الزامی" Mode="VisualMode.CheckBox"
                                                   AllowFiltering="true" FilterBarPlaceholder="برای جستجو تایپ کنید..." FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains"
                                                   ShowClearButton="true" SelectAllText="انتخاب همه" ShowSelectAll="true"
                                                   UnSelectAllText="حذف همه"/>
                                </MudField>
                            </MudItem>
                        </MudGrid>
                    </MudRTLProvider>
                </Template>
            </GridEditSettings>
        </SfGrid>
    </MudCardContent>
</MudCard>