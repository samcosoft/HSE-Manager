@inject IDataLayer DataLayer
@inject IWebHostEnvironment HostEnvironment
@inject ISnackbar Snackbar
@inject SfDialogService DialogService
@using System.Text.Json
@using Samco_HSE.HSEData
@using Syncfusion.Blazor.Popups
@implements IDisposable

<MudDialog>
    <DialogContent>
        <MudCard>
            <MudCardContent>
                <SfDocumentEditorContainer @ref="_container" EnableToolbar="true" Height="100vh" DocumentEditorSettings="_settings">
                    <DocumentEditorContainerEvents Created="OnCreated"></DocumentEditorContainerEvents>
                </SfDocumentEditorContainer>
            </MudCardContent>
        </MudCard>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Success" Variant="Variant.Filled" StartIcon="fas fa-check" OnClick="SaveDocument">ذخیره گزارش</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" StartIcon="fas fa-xmark" OnClick="CancelButton">انصراف</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string? DocumentPath { get; set; }

    [Parameter]
    public int ReportId { get; set; }


    private Session? _session1;
    private SfDocumentEditorContainer? _container;
    private readonly DocumentEditorSettingsModel _settings = new() { FontFamilies = ["Tahoma", "Calibri", "B Nazanin", "B Titr", "IranYekanRd"] };
    private Report? _selReport;


    protected override void OnInitialized()
    {
        base.OnInitialized();
        _session1 = new Session(DataLayer);
        _selReport = _session1.GetObjectByKey<Report>(ReportId);
    }

    private async void OnCreated(object obj)
    {
        if (string.IsNullOrEmpty(DocumentPath)) return;

        await using var fileStream = new FileStream(DocumentPath, FileMode.Open, FileAccess.Read);
        var document = WordDocument.Load(fileStream, DocumentPath.Split(".").Last() == "docx" ? ImportFormatType.Docx : ImportFormatType.Doc);
        var json = JsonSerializer.Serialize(document);
        document.Dispose();
        //To observe the memory go down, null out the reference of document variable.
        // ReSharper disable once RedundantAssignment
        document = null;
        var editor = _container!.DocumentEditor;
        await editor.OpenAsync(json);
        //To observe the memory go down, null out the reference of json variable.
        // ReSharper disable once RedundantAssignment
        json = null;
    }

    private async void SaveDocument()
    {
        if (await DialogService.ConfirmAsync("آیا از ذخیره گزارش مطمئنید؟", "ذخیره گزارش") == false) return;

        var editor = _container!.DocumentEditor;
        var base64Data = await editor.SaveAsBlobAsync(FormatType.Docx);
        var data = Convert.FromBase64String(base64Data);
        //To observe the memory go down, null out the reference of base64Data variable.
        //Word document file stream
        Stream stream = new MemoryStream(data);
        //To observe the memory go down, null out the reference of data variable.
        await using (var fileStream = new FileStream(DocumentPath!, FileMode.Create, FileAccess.Write))
        {
            //Saving the new file in root path of application
            await stream.CopyToAsync(fileStream);
            fileStream.Close();
        }
        stream.Close();

        //Update file info
        _selReport!.SubDate = DateTime.Now;
        _selReport.Save();
        Snackbar.Add("گزارش با موفقیت ذخیره شد.", Severity.Success);
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void CancelButton() => MudDialog.Cancel();

    public void Dispose()
    {
        _session1?.Dispose();
        ((IDisposable)_container!).Dispose();
    }
}
