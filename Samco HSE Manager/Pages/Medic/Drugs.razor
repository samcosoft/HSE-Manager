@page "/drug"
@attribute [Authorize(Roles = "Owner,Admin,Supervisor,Officer,Medic")]
@using Samco_HSE.HSEData
@using Microsoft.AspNetCore.Components

<PageTitle>داروها و تجهیزات پزشکی</PageTitle>
<MudCard>
    <MudCardHeader>
        <DxMenu Title="داروها و تجهیزات پزشکی" ItemsPosition="ItemPosition.Start" CssClass="card-header">
            <Items>
                <DxMenuItem Text="تنظیم موجودی" IconCssClass="fas fa-suitcase-medical" @onclick="OnSetNumberBtnClick" />
                <DxMenuItem Text="درخواست دارو / تجهیزات" IconCssClass="fas fa-truck-medical" @onclick="OnDrugRequestBtnClick" />
            </Items>
        </DxMenu>
    </MudCardHeader>
    <MudCardContent>
        <DxGrid @ref="MedicineGrid" Data="@MedicineList" KeyFieldName="Oid" EditMode="GridEditMode.PopupEditForm"
                EditModelSaving="OnEditModelSaving" DataItemDeleting="OnDataItemDeleting" UnboundColumnData="MedicationGridUnbound"
                CustomizeEditModel="MedicineEditModel" EditStart="MedicineEditStart"
                ShowSearchBox="true" ShowFilterRow="true" ShowGroupPanel="true" ValidationEnabled="false"
                SelectionMode="GridSelectionMode.Single" AllowSelectRowByClick="true"
                ColumnResizeMode="GridColumnResizeMode.ColumnsContainer"
                SearchBoxNullText="برای جستجو تایپ کنید..." CssClass="text-center">
            <Columns>
                <DxGridCommandColumn/>
                <DxGridDataColumn FieldName="@nameof(Medication.Name)" Caption="نام دارو / تجهیز" Width="15%"/>
                <DxGridDataColumn FieldName="@nameof(Medication.Dose)" Caption="دوز" MinWidth="100"/>
                <DxGridDataColumn FieldName="@nameof(Medication.DrugForm)" Caption="فرم دارویی" MinWidth="100">
                    <FilterRowCellTemplate>
                        <TagBoxFilterRow TData="string" FilterContext="context" DataSource="_drugFormList" />
                    </FilterRowCellTemplate>
                </DxGridDataColumn>
                <DxGridDataColumn FieldName="@nameof(Medication.Category)" Caption="دسته بندی" MinWidth="100">
                    <FilterRowCellTemplate>
                        <OperatorType FilterContext="@context">
                            <DxComboBox Data="_category"
                                        Value="(string?)context.FilterRowValue" AllowUserInput="true"
                                        ValueChanged="(string? v) => context.FilterRowValue = v" />
                        </OperatorType>
                    </FilterRowCellTemplate>
                </DxGridDataColumn>
                <DxGridDataColumn Caption="قابل درخواست" FieldName="@nameof(Medication.AvailForOrder)" MinWidth="70">
                    <CellDisplayTemplate>
                        <DxCheckBox CssClass="d-inline-block" Checked="@((bool)context.Value)" Enabled="false"/>
                    </CellDisplayTemplate>
                    <FilterRowCellTemplate>
                        <OperatorType FilterContext="@context">
                            <DxComboBox Data="SamcoSoftShared.ComboboxBoolean" TextFieldName="Key" ValueFieldName="Value"
                                        Value="(bool?)context.FilterRowValue" AllowUserInput="true"
                                        ValueChanged="(bool? v) => context.FilterRowValue = v" />
                        </OperatorType>
                    </FilterRowCellTemplate>
                </DxGridDataColumn>
                <DxGridDataColumn FieldName="@nameof(Medication.MinCount)" Caption="حداقل تعداد"/>
                <DxGridDataColumn FieldName="@nameof(Medication.Discription)" Caption="توضیحات" MinWidth="100"/>
                @BuildColumnsGrid()
            </Columns>
            <EditFormTemplate Context="editFormContext">
                @{
                    var drug = (Medication)editFormContext.EditModel;
                }
                <DxFormLayout>
                    <DxFormLayoutItem Caption="نام دارو / تجهیز:">
                        <DxTextBox @bind-Text="@drug.Name" NullText="الزامی" InputCssClass="ltr" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="دوز / اندازه:">
                        <DxTextBox @bind-Text="@drug.Dose" NullText="الزامی - مثال: 100mg یا 5% ..." InputCssClass="ltr" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="فرم دارویی:">
                        <DxComboBox Data="@_drugFormList" @bind-Value="@drug.DrugForm" NullText="الزامی" FilteringMode="DataGridFilteringMode.Contains" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="دسته بندی:">
                        <DxComboBox Data="@_category" @bind-Value="@drug.Category" NullText="الزامی" FilteringMode="DataGridFilteringMode.Contains" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="حداقل تعداد:">
                        <DxSpinEdit @bind-Value="drug.MinCount" MinValue="1" MaxValue="1000" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="قابل درخواست:">
                        <DxCheckBox @bind-Checked="@drug.AvailForOrder" />
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="توضیحات:">
                        <DxTextBox @bind-Text="@drug.Discription" />
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditFormTemplate>
        </DxGrid>
    </MudCardContent>
</MudCard>

<DxPopup @ref="SetNumberModal" HeaderText="تنظیم تعداد تجهیز" ShowFooter="true" CloseOnOutsideClick="false" CloseOnEscape="false">
    <BodyContentTemplate Context="_">
        <DxFormLayout>
            <DxFormLayoutItem Caption="نام تجهیز:" ColSpanMd="4" ColSpanSm="12">
                <DxTextBox @bind-Text="@_selMedicationStock!.MedicName.Name" ReadOnly="true" />
            </DxFormLayoutItem>
            <DxFormLayoutItem Caption="نام دکل / دفتر:" ColSpanMd="4" ColSpanSm="12">
                <DxComboBox TValue="Rig" TData="Rig" @ref="RigBx" Data="@Rigs" TextFieldName="@nameof(Rig.Name)" NullText="الزامی" ValueChanged="RigSelectionChanged" />
            </DxFormLayoutItem>
            <DxFormLayoutItem Caption="تعداد:" ColSpanMd="4" ColSpanSm="12">
                <DxSpinEdit T="short" @bind-Value="@_selMedicationStock!.AvailCount" MinValue="0" MaxValue="1000" />
            </DxFormLayoutItem>
        </DxFormLayout>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <MudButton Color="Color.Success" StartIcon="fas fa-check" OnClick="SetCountOkBtnClick">تأیید</MudButton>
    </FooterContentTemplate>
</DxPopup>

<DxPopup @ref="DrugRequestModal" HeaderText="درخواست دارو / تجهیزات" ShowFooter="true" CloseOnOutsideClick="false" CloseOnEscape="false">
    <BodyContentTemplate Context="_">
        <MudAlert Severity="Severity.Info" Icon="fas fa-info" Elevation="3">درخواست داروها بر اساس حداقل تعداد دارو / تجهیز تنظیم می‌شود. شما می‌توانید پس از دریافت فایل درخواست مقادیر آن‌ها را تغییر دهید.</MudAlert>
        <DxFormLayout>
            <DxFormLayoutItem Caption="نام دکل / دفتر:" ColSpanMd="4" ColSpanSm="12">
                <DxComboBox Data="@Rigs" @bind-Value="_selRig" TextFieldName="@nameof(Rig.Name)" NullText="الزامی"/>
            </DxFormLayoutItem>
        </DxFormLayout>
    </BodyContentTemplate>
    <FooterContentTemplate>
        <MudButton Color="Color.Success" StartIcon="fas fa-check" OnClick="RequestBtnClick">تأیید</MudButton>
    </FooterContentTemplate>
</DxPopup>