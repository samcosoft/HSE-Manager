@page "/medication"
@attribute [Authorize(Roles = "Owner,Admin,Supervisor,Officer,Medic")]
@using Samco_HSE.HSEData
@using FilterType = Syncfusion.Blazor.Grids.FilterType

<PageTitle>داروها و تجهیزات پزشکی</PageTitle>
<MudCard>
    <MudCardHeader>
        <MudPaper Elevation="3" Width="100%" Class="pa-3">
            <MudGrid>
                <MudItem>
                    <MudText Typo="Typo.h5">داروها و تجهیزات پزشکی</MudText>
                </MudItem>
                <MudItem>
                    <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                        <MudButton StartIcon="fas fa-suitcase-medical" IconColor="Color.Success" OnClick="OnSetNumberBtnClick">تنظیم موجودی</MudButton>
                        @* <MudButton StartIcon="fas fa-truck-medical" IconColor="Color.Info" OnClick="OnDrugRequestBtnClick">درخواست دارو / تجهیزات</MudButton> *@
                        <MudButton StartIcon="fas fa-prescription-bottle-medical" IconColor="Color.Warning" OnClick="OnDrugDiscardBtnClick">دور انداختن دارو / تجهیزات</MudButton>
                    </MudButtonGroup>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudCardHeader>
    <MudCardContent>
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true">
            <MudTabPanel Text="موجودی دارو / تجهیزات">
                <SfGrid @ref="MedicineGrid" ID="medicGrid" DataSource="@MedicineList" AllowPaging="true" AllowSorting="true" AllowFiltering="true" EnableStickyHeader="true"
                        AllowGrouping="true" Toolbar="@(new[] { "Add", "Edit", "Delete", "Excel Export", "Search", "ColumnChooser" })" ClipMode="ClipMode.EllipsisWithTooltip"
                        AllowResizing="true" ShowColumnChooser="true" EnableAdaptiveUI="true" AdaptiveUIMode="AdaptiveMode.Mobile"
                        AllowExcelExport="true" Width="100%">
                    <GridEvents TValue="Medication" OnActionBegin="MedicGrid_Action"
                                OnToolbarClick="MedicToolbarClickHandler" />
                    <GridFilterSettings Type="FilterType.Excel" />
                    <GridColumns>
                        <GridColumn HeaderText="ردیف" Field="Oid" IsPrimaryKey="true" Visible="false" />
                        <GridColumn Field="@nameof(Medication.Name)" HeaderText="نام دارو / تجهیز" Width="15%" AutoFit="true" />
                        <GridColumn Field="@nameof(Medication.Dose)" HeaderText="دوز" MinWidth="100" AutoFit="true" />
                        <GridColumn Field="@nameof(Medication.DrugForm)" HeaderText="فرم دارویی" MinWidth="100" AutoFit="true" />
                        <GridColumn Field="@nameof(Medication.Category)" HeaderText="دسته بندی" MinWidth="100" AutoFit="true" />
                        <GridColumn Field="@nameof(Medication.AvailForOrder)" HeaderText="قابل درخواست" MinWidth="70" AutoFit="true"
                                    DisplayAsCheckBox="true" />
                        <GridColumn Field="@nameof(Medication.MinCount)" HeaderText="حداقل تعداد" AutoFit="true" />
                        <GridColumn Field="@nameof(Medication.Discription)" HeaderText="توضیحات" MinWidth="100" />
                        @{
                            if (Rigs != null && Rigs.Any())
                            {
                                foreach (var rig in Rigs)
                                {
                                    <GridColumn HeaderText="@($"موجودی {rig.Name}")" AutoFit="true">
                                        <Template>
                                            @{
                                                var itm = context as Medication;
                                                @MedicGridUnbound(rig.Oid, itm)
                                            }
                                        </Template>
                                    </GridColumn>
                                }
                            }
                        }
                    </GridColumns>
                    <GridEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" AllowEditOnDblClick="true" Mode="EditMode.Dialog"
                                      ShowDeleteConfirmDialog="true" Dialog="@SamcoSoftShared.GeneralGridEditOption">
                        <Validator>
                            <DataAnnotationsValidator />
                        </Validator>
                        <Template Context="editFormContext">
                            @{
                                var drug = (Medication)editFormContext;
                            }
                            <MudRTLProvider RightToLeft="true">
                                <MudGrid>
                                    <MudItem md="6" sm="12">
                                        <MudTextField Label="نام دارو / تجهیز:" @bind-Value="@drug.Name" Placeholder="الزامی"
                                                      Class="ltr" Adornment="Adornment.Start" AutoFocus="true" />
                                    </MudItem>
                                    <MudItem md="6" sm="12">
                                        <MudTextField Label="مدل:" @bind-Value="@drug.Dose"
                                                      Adornment="Adornment.Start" Placeholder="الزامی - مثال: 100mg یا 5% ..." Class="ltr" />
                                    </MudItem>
                                    <MudItem md="6" sm="12">
                                        <MudField Label="فرم دارویی:" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@_drugFormList" @bind-Value="@drug.DrugForm" Placeholder="الزامی" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" AllowFiltering="true" />
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="6" sm="12">
                                        <MudField Label="دسته بندی:" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@_category" @bind-Value="@drug.Category" Placeholder="الزامی" FilterType="Syncfusion.Blazor.DropDowns.FilterType.Contains" AllowFiltering="true" />
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="6" sm="12">
                                        <MudNumericField T="int" @bind-Value="@drug.MinCount" Label="حداقل تعداد:" Adornment="Adornment.Start"
                                                         Min="1" Max="5000" Step="1" />
                                    </MudItem>
                                    <MudItem md="6" sm="12">
                                        <MudCheckBox @bind-Value="@drug.AvailForOrder" Label="قابل درخواست" />
                                    </MudItem>
                                    <MudItem md="6" sm="12">
                                        <MudTextField Label="توضیحات:" @bind-Value="@drug.Discription" Adornment="Adornment.Start" />
                                    </MudItem>
                                </MudGrid>
                            </MudRTLProvider>
                        </Template>
                    </GridEditSettings>
                </SfGrid>
            </MudTabPanel>
            <MudTabPanel Text="داروها و تجهیزات معدوم شده">
                <MudDataGrid Items="DiscardList" SortMode="SortMode.Multiple" Filterable="true" QuickFilter="@_quickFilter"
                             Hideable="true">
                    <ToolBarContent>
                        <MudTextField @bind-Value="_searchString" Placeholder="جستجو..." Adornment="Adornment.Start" Immediate="true"
                                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    </ToolBarContent>
                    <Columns>
                        <PropertyColumn Title="نام دارو / تجهیز" Property="x=>x.MedicName.Name" />
                        <PropertyColumn Title="محل" Property="x=>x.RigNo.Name" />
                        <PropertyColumn Title="تاریخ" Property="x=>x.DisDate" />
                        <PropertyColumn Title="تعداد" Property="x=>x.MedCount" />
                        <PropertyColumn Title="دلیل معدوم شدن" Property="x=>x.Reason" />
                        <TemplateColumn CellClass="d-flex justify-end">
                            <CellTemplate>
                                <MudStack Row>
                                    <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Info"
                                               StartIcon="@Icons.Material.Filled.RestoreFromTrash"
                                               OnClick="()=>RestoreMedication(context.Item)">بازگردانی</MudButton>
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudTabPanel>
        </MudTabs>

    </MudCardContent>
</MudCard>