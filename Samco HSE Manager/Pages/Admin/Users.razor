@page "/users"
@attribute [Authorize(Roles = "Owner,Admin")]
@using Samco_HSE.HSEData
@using Syncfusion.Blazor.Popups
@using FilterType = Syncfusion.Blazor.Grids.FilterType
@inject IStringLocalizer<Resource> L


<PageTitle>@L["Users_Title"]</PageTitle>

<MudCard Class="h-100">
    <MudCardHeader>
        <MudPaper Elevation="3" Width="100%" Class="pa-3">
            <MudGrid>
                <MudItem>
                    <MudText Typo="Typo.h5">@L["Users_Title"]</MudText>
                </MudItem>
                <MudItem>
                    <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                        <MudButton StartIcon="fas fa-key" IconColor="Color.Error" OnClick="OnNewPassBtnClick">@L["Users_NewPassButton"]</MudButton>
                        <MudButton StartIcon="fas fa-unlock" IconColor="Color.Warning" OnClick="OnPermitBtnClick">@L["Users_PermitButton"]</MudButton>
                        <MudButton StartIcon="fas fa-user" IconColor="Color.Tertiary" OnClick="OnUpgradeBtnClick">@L["Users_UpgradeButton"]</MudButton>
                    </MudButtonGroup>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudCardHeader>
    <MudCardContent>
        <SfGrid @ref="UserGrid" ID="userGrid" DataSource="@SystemUsers" AllowPaging="true" AllowSorting="true" AllowFiltering="true" EnableStickyHeader="true"
                AllowGrouping="true" Toolbar="@(new[] { "Add", "Edit", "Delete", "Excel Export", "Search", "ColumnChooser" })" ClipMode="ClipMode.EllipsisWithTooltip"
                AllowResizing="true" ShowColumnChooser="true" EnableAdaptiveUI="true" AdaptiveUIMode="AdaptiveMode.Mobile"
                AllowExcelExport="true" Width="100%" EnableRtl="IsRightToLeft">
            <GridEvents TValue="User" OnActionBegin="UserGrid_Action"
                        OnToolbarClick="UserToolbarClickHandler" />
            <GridFilterSettings Type="FilterType.Excel" />
            <GridColumns>
                <GridColumn HeaderText="@L["GridHeaderOid"]" Field="Oid" IsPrimaryKey="true" Visible="false" />
                <GridColumn HeaderText="@L["GridHeaderLocation"]" Field="ActiveRig.Name" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderUsername"]" Field="Username" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderRoles"]" Field="SiteRole" AutoFit="true" />
                <GridColumn HeaderText="@L["SamcoPersonnelSelector.Name"]" Field="PersonnelName" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderNationalId"]" Field="NationalID" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderBirthDate"]" Field="BirthDate" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderIsMarried"]" Field="Marriage" AutoFit="true" DisplayAsCheckBox="true" />
                <GridColumn HeaderText="@L["GridHeaderPersonnelNumber"]" Field="PersonnelNum" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderCurrentRole"]" Field="CurrentRole" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderEmploymentDate"]" Field="EmpDate" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderMobilePhone"]" Field="MobileNum" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderEmploymentDate"]" Field="BusinessEmail" AutoFit="true" />
                <GridColumn HeaderText="@L["GridHeaderStatus"]" Field="Status" AutoFit="true" />
                <GridColumn HeaderText="@L["LastLoginDate"]" Field="LastLogin" AutoFit="true" />
            </GridColumns>
            <GridEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" AllowEditOnDblClick="true" Mode="EditMode.Dialog"
                              ShowDeleteConfirmDialog="true" Dialog="@SamcoSoftShared.GeneralGridEditOption">
                <Validator>
                    <DataAnnotationsValidator />
                </Validator>
                <Template Context="editFormContext">
                    @{
                        var user = editFormContext as User;
                    }
                    <MudRTLProvider RightToLeft="IsRightToLeft">
                        <MudExpansionPanels MultiExpansion="true">
                            <MudExpansionPanel Text="@L["User_Login_Info"]" Expanded="true">
                                <MudGrid>
                                    <MudItem md="4" sm="12">
                                        <MudTextField Label="@($"{L["GridHeaderUsername"]}:")" @bind-Value="@user.Username" Variant="Variant.Text" Placeholder="@L["RequiredText"]"/>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderRole"]}:")" Underline="false">
                                            <SfComboBox TItem="KeyValuePair<string, string>" TValue="string" DataSource="@_roles" Placeholder="@L["RequiredText"]"
                                                        @bind-Value="@user.SiteRole">
                                                <ComboBoxFieldSettings Text="Value" Value="Key" />
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["NavMenu_Dashboard"]}:")" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@Dashboards" Placeholder="@L["RequiredText"]"
                                                        @bind-Value="@user.DashboardId">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                </MudGrid>
                            </MudExpansionPanel>
                            <MudExpansionPanel Text="@L["LabelPersonalInfo"]" Expanded="true">
                                <MudGrid>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.PersonnelName" Label="@($"{L["GridHeaderPersonnelName"]}:")" Variant="Variant.Text" Placeholder="@L["RequiredText"]" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.EnglishName" Label="@($"{L["GridHeaderPersonnelEnglishName"]}:")" Variant="Variant.Text" Adornment="Adornment.Start"/>
                                    </MudItem>
                                    @* <MudItem md="4" sm="12">
                                        <SfImageEditor @ref="ImageEditor" Height="150">
                                            <ImageEditorEvents Created="()=> OpenImageAsync(user.Oid)" />
                                        </SfImageEditor>
                                    </MudItem> *@
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.NationalID" Label="@($"{L["GridHeaderNationalId"]}:")" Variant="Variant.Text" Mask="@(new PatternMask("0000000000"))" Placeholder="@L["RequiredText"]"/>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderBirthDate"]}:")" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.BirthDate"/>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderMarriageStatus"]}:")" Underline="false">
                                            <MudCheckBox @bind-Value="@user.Marriage" Label="@L["GridHeaderMarried"]" />
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.MobileNum" Label="@($"{L["GridHeaderMobilePhone"]}:")" Variant="Variant.Text" Mask="@(new PatternMask("00000000000"))" Adornment="Adornment.Start"/>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.HomeNum" Label="@($"{L["GridHeaderHomePhone_Label"]}:")" Variant="Variant.Text" Mask="@(new PatternMask("00000000000"))" Adornment="Adornment.Start"/>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.InsuranceNum" Label="@($"{L["GridHeaderInsuranceNumber"]}:")" Variant="Variant.Text" Adornment="Adornment.Start"/>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderDriverExpDate"]}:")" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.LicenseDate"/>
                                        </MudField>
                                    </MudItem>
                                </MudGrid>
                            </MudExpansionPanel>
                            <MudExpansionPanel Text="@L["LabelJobInfo"]" Expanded="true">
                                <MudGrid>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderLocation"]}:")" Underline="false">
                                            <SamcoRigSelector @bind-SelectedRig="@user.ActiveRig" DataSource="Rigs" IsMultiselect="false"/>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderEmploymentDate"]}:")" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.EmpDate"/>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderCurrentRole"]}:")" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@RigRoles" Placeholder="@L["RequiredText"]"
                                                        @bind-Value="@user.CurrentRole">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField Label="@($"{L["GridHeaderPersonnelNumber"]}:")" @bind-Value="@user.PersonnelNum" Variant="Variant.Text" Placeholder="@L["RequiredText"]"/>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderStatus"]}:")" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@_status" Placeholder="@L["RequiredText"]"
                                                        @bind-Value="@user.Status">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.BusinessEmail" Variant="Variant.Text" Label="@($"{L["GridHeaderBusinessEmail"]}:")"
                                                      Mask="@(RegexMask.Email())" InputMode="InputMode.email" Adornment="Adornment.Start" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderPreviousRoleLabel"]}:")" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@RigRoles"
                                                        @bind-Value="@user.PreviousRole">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="@($"{L["GridHeaderLastPromotion"]}:")" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.LastUpgradeDate"/>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudNumericField Label="@($"{L["GridHeaderClothSize"]}:")" Min="35" Max="50" @bind-Text="@user.ClothSize" Adornment="Adornment.Start" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudNumericField Label="@($"{L["GridHeaderShoeSize"]}:")" Min="35" Max="50" @bind-Text="@user.ShoeSize" Adornment="Adornment.Start" />
                                    </MudItem>
                                </MudGrid>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    </MudRTLProvider>
                </Template>
            </GridEditSettings>
        </SfGrid>
    </MudCardContent>
</MudCard>

<SfDialog @ref="PassModal" AllowDragging="true" Visible="false" IsModal="true" Width="600px" ShowCloseIcon="true"
          Header="@L["Users_SetNewPassTitle"]" CloseOnEscape="true" EnableRtl="IsRightToLeft">
    <DialogTemplates>
        <Content>
            <MudGrid>
                <MudItem>
                    <MudTextField Label="@($"{L["Users_NewPasswordLabel"]}:")" @bind-Value="@_newPass" InputType="InputType.Password" />
                </MudItem>
                <MudItem>
                    <MudTextField Label="@($"{L["Users_ConfirmNewPasswordLabel"]}:")" @bind-Value="@_confPass" InputType="InputType.Password" />
                </MudItem>
            </MudGrid>
        </Content>
        <FooterTemplate>
            <MudButton Color="Color.Success" StartIcon="fas fa-check" Variant="Variant.Filled" OnClick="PassOkBtnClick">@L["ConfirmButtonText"]</MudButton>
        </FooterTemplate>
    </DialogTemplates>
    <DialogPositionData Y="top" />
    <DialogAnimationSettings Effect="DialogEffect.FadeZoom" />
</SfDialog>

<SfDialog @ref="PermitModal" AllowDragging="true" Visible="false" IsModal="true" Width="600px" ShowCloseIcon="true"
          Header="@L["Users_AccessLevelTitle"]" CloseOnEscape="true" EnableRtl="IsRightToLeft">
    <DialogTemplates>
        <Content>
            <MudAlert Variant="Variant.Filled" Severity="Severity.Info">@L["Users_AccessLevelInfoText"]</MudAlert>
            <SamcoRigSelector @bind-SelectedRigs="PermitRigList" IsMultiselect="true" DataSource="Rigs"/>
        </Content>
        <FooterTemplate>
            <MudButton Color="Color.Success" StartIcon="fas fa-check" Variant="Variant.Filled" OnClick="PermitOkBtnClick">@L["ConfirmButtonText"]</MudButton>
        </FooterTemplate>
    </DialogTemplates>
    <DialogPositionData Y="top" />
    <DialogAnimationSettings Effect="DialogEffect.FadeZoom" />
</SfDialog>

<SfDialog @ref="UpgradeModal" AllowDragging="true" Visible="false" IsModal="true" Width="600px" ShowCloseIcon="true"
          Header="@L["Users_UpgradePersonnelTitle"]" CloseOnEscape="true" EnableRtl="IsRightToLeft">
    <DialogTemplates>
        <Content>
            <MudAlert Variant="Variant.Filled" Severity="Severity.Info">@L["Users_UpgradePersonnelInfoText"]</MudAlert>
            <MudRTLProvider RightToLeft="IsRightToLeft">
                <MudGrid>
                    <MudItem md="12">
                        <MudField Label="@($"{L["GridHeaderPersonnelName"]}:")" Underline="false">
                            <SamcoPersonnelSelector @bind-SelectedPersonnel="_selPersonnel" DataSource="PersonnelList" Session="Session1" />
                        </MudField>
                    </MudItem>
                    <MudItem md="6" sm="12">
                        <MudTextField Label="@($"{L["GridHeaderUsername"]}:")" @bind-Value="@_personnelUsername" Variant="Variant.Text"
                                      Placeholder="@L["RequiredText"]"/>
                    </MudItem>
                    <MudItem md="6" sm="12">
                        <MudField Label="@($"{L["GridHeaderRole"]}:")" Underline="false">
                            <SfComboBox TItem="KeyValuePair<string, string>" TValue="string" DataSource="@_roles" Placeholder="@L["RequiredText"]"
                                        @bind-Value="@_personnelRole">
                                <ComboBoxFieldSettings Text="Value" Value="Key" />
                            </SfComboBox>
                        </MudField>
                    </MudItem>
                </MudGrid>
            </MudRTLProvider>
        </Content>
        <FooterTemplate>
            <MudButton Color="Color.Success" StartIcon="fas fa-check" Variant="Variant.Filled" OnClick="UpgradeOkBtnClick">@L["ConfirmButtonText"]</MudButton>
        </FooterTemplate>
    </DialogTemplates>
    <DialogPositionData Y="top" />
    <DialogAnimationSettings Effect="DialogEffect.FadeZoom" />
</SfDialog>