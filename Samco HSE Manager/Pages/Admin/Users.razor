@page "/users"
@attribute [Authorize(Roles = "Owner,Admin")]
@using Samco_HSE.HSEData
@using Syncfusion.Blazor.Popups
@using FilterType = Syncfusion.Blazor.Grids.FilterType


<PageTitle>مدیریت کاربران</PageTitle>

<MudCard Class="h-100">
    <MudCardHeader>
        <MudPaper Elevation="3" Width="100%" Class="pa-3">
            <MudGrid>
                <MudItem>
                    <MudText Typo="Typo.h5">مدیریت کاربران</MudText>
                </MudItem>
                <MudItem>
                    <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled">
                        <MudButton StartIcon="fas fa-key" IconColor="Color.Error" OnClick="OnNewPassBtnClick">تنظیم کلمه عبور</MudButton>
                        <MudButton StartIcon="fas fa-unlock" IconColor="Color.Warning" OnClick="OnPermitBtnClick">تنظیم دسترسی اطلاعات</MudButton>
                        <MudButton StartIcon="fas fa-user" IconColor="Color.Tertiary" OnClick="OnUpgradeBtnClick">دسترسی پرسنل</MudButton>
                    </MudButtonGroup>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudCardHeader>
    <MudCardContent>
        <SfGrid @ref="UserGrid" ID="userGrid" DataSource="@SystemUsers" AllowPaging="true" AllowSorting="true" AllowFiltering="true" EnableStickyHeader="true"
                AllowGrouping="true" Toolbar="@(new[] { "Add", "Edit", "Delete", "Excel Export", "Search", "ColumnChooser" })" ClipMode="ClipMode.EllipsisWithTooltip"
                AllowResizing="true" ShowColumnChooser="true" EnableAdaptiveUI="true" AdaptiveUIMode="AdaptiveMode.Mobile"
                AllowExcelExport="true" Width="100%">
            <GridEvents TValue="User" OnActionBegin="UserGrid_Action"
                        OnToolbarClick="UserToolbarClickHandler" />
            <GridFilterSettings Type="FilterType.Excel" />
            <GridColumns>
                <GridColumn HeaderText="ردیف" Field="Oid" IsPrimaryKey="true" Visible="false" />
                <GridColumn HeaderText="دکل / دفتر" Field="ActiveRig.Name" AutoFit="true" />
                <GridColumn HeaderText="نام کاربری" Field="Username" AutoFit="true" />
                <GridColumn HeaderText="نقش" Field="SiteRole" AutoFit="true" />
                <GridColumn HeaderText="نام و نام خانوادگی" Field="PersonnelName" AutoFit="true" />
                <GridColumn HeaderText="کد ملی" Field="NationalID" AutoFit="true" />
                <GridColumn HeaderText="تاریخ تولد" Field="BirthDate" AutoFit="true" />
                <GridColumn HeaderText="متأهل" Field="Marriage" AutoFit="true" DisplayAsCheckBox="true" />
                <GridColumn HeaderText="شماره پرسنلی" Field="PersonnelNum" AutoFit="true" />
                <GridColumn HeaderText="سمت فعلی" Field="CurrentRole" AutoFit="true" />
                <GridColumn HeaderText="تاریخ استخدام" Field="EmpDate" AutoFit="true" />
                <GridColumn HeaderText="تلفن همراه" Field="MobileNum" AutoFit="true" />
                <GridColumn HeaderText="ایمیل" Field="BusinessEmail" AutoFit="true" />
                <GridColumn HeaderText="وضعیت" Field="Status" AutoFit="true" />
                <GridColumn HeaderText="تاریخ آخرین ورود به سیستم" Field="LastLogin" AutoFit="true" />
            </GridColumns>
            <GridEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" AllowEditOnDblClick="true" Mode="EditMode.Dialog"
                              ShowDeleteConfirmDialog="true" Dialog="@SamcoSoftShared.GeneralGridEditOption">
                <Validator>
                    <DataAnnotationsValidator />
                </Validator>
                <Template Context="editFormContext">
                    @{
                        var user = editFormContext as User;
                    }
                    <MudRTLProvider RightToLeft="true">
                        <MudExpansionPanels MultiExpansion="true">
                            <MudExpansionPanel Text="اطلاعات ورود به سیستم" Expanded="true">
                                <MudGrid>
                                    <MudItem md="4" sm="12">
                                        <MudTextField Label=":نام کاربری" @bind-Value="@user.Username" Variant="Variant.Text" Placeholder="الزامی" Class="ltr" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="نقش:" Underline="false">
                                            <SfComboBox TItem="KeyValuePair<string, string>" TValue="string" DataSource="@_roles" Placeholder="الزامی"
                                                        @bind-Value="@user.SiteRole">
                                                <ComboBoxFieldSettings Text="Value" Value="Key" />
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="داشبورد:" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@Dashboards" Placeholder="الزامی"
                                                        @bind-Value="@user.DashboardId">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                </MudGrid>
                            </MudExpansionPanel>
                            <MudExpansionPanel Text="اطلاعات شخصی" Expanded="true">
                                <MudGrid>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.PersonnelName" Label="نام و نام خانوادگی:" Variant="Variant.Text" Placeholder="الزامی" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.EnglishName" Label=":نام و نام خانوادگی (انگلیسی)" Variant="Variant.Text" Adornment="Adornment.Start" Class="ltr" />
                                    </MudItem>
                                    @* <MudItem md="4" sm="12">
                                        <SfImageEditor @ref="ImageEditor" Height="150">
                                            <ImageEditorEvents Created="()=> OpenImageAsync(user.Oid)" />
                                        </SfImageEditor>
                                    </MudItem> *@
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.NationalID" Label=":کد ملی" Variant="Variant.Text" Mask="@(new PatternMask("0000000000"))" Placeholder="الزامی" Class="ltr" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="تاریخ تولد:" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.BirthDate" DefaultCalendar="SamcoDateSelector.CalendarType.Persian" />
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="وضعیت تأهل:" Underline="false">
                                            <MudCheckBox @bind-Value="@user.Marriage" Label="متأهل" />
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.MobileNum" Label=":تلفن همراه" Variant="Variant.Text" Mask="@(new PatternMask("00000000000"))" Adornment="Adornment.Start" Class="ltr" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.HomeNum" Label=":تلفن منزل" Variant="Variant.Text" Mask="@(new PatternMask("00000000000"))" Adornment="Adornment.Start" Class="ltr" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.InsuranceNum" Label=":شماره بیمه" Variant="Variant.Text" Adornment="Adornment.Start" Class="ltr" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="تاریخ انقضا گواهینامه:" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.LicenseDate" DefaultCalendar="SamcoDateSelector.CalendarType.Persian" />
                                        </MudField>
                                    </MudItem>
                                </MudGrid>
                            </MudExpansionPanel>
                            <MudExpansionPanel Text="اطلاعات شغلی" Expanded="true">
                                <MudGrid>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="نام دکل / محل فعالیت:" Underline="false">
                                            <SamcoRigSelector @bind-SelectedRig="@user.ActiveRig" DataSource="Rigs" IsMultiselect="false"/>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="تاریخ استخدام:" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.EmpDate" DefaultCalendar="SamcoDateSelector.CalendarType.Persian" />
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="سمت فعلی:" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@RigRoles" Placeholder="الزامی"
                                                        @bind-Value="@user.CurrentRole">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField Label=":شماره پرسنلی" @bind-Value="@user.PersonnelNum" Variant="Variant.Text" Placeholder="الزامی" Class="ltr" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="وضعیت:" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@_status" Placeholder="الزامی"
                                                        @bind-Value="@user.Status">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudTextField @bind-Value="@user.BusinessEmail" Variant="Variant.Text" Label=":ایمیل سازمانی"
                                                      Mask="@(RegexMask.Email())" Class="ltr" InputMode="InputMode.email" Adornment="Adornment.Start" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="سمت قبلی:" Underline="false">
                                            <SfComboBox TItem="string" TValue="string" DataSource="@RigRoles"
                                                        @bind-Value="@user.PreviousRole">
                                            </SfComboBox>
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudField Label="تاریخ آخرین ارتقا:" Underline="false">
                                            <SamcoDateSelector @bind-Date="@user.LastUpgradeDate" DefaultCalendar="SamcoDateSelector.CalendarType.Persian" />
                                        </MudField>
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudNumericField Label="سایز لباس:" Min="35" Max="50" @bind-Text="@user.ClothSize" Adornment="Adornment.Start" />
                                    </MudItem>
                                    <MudItem md="4" sm="12">
                                        <MudNumericField Label="سایز کفش:" Min="35" Max="50" @bind-Text="@user.ShoeSize" Adornment="Adornment.Start" />
                                    </MudItem>
                                </MudGrid>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    </MudRTLProvider>
                </Template>
            </GridEditSettings>
        </SfGrid>
    </MudCardContent>
</MudCard>

<SfDialog @ref="PassModal" AllowDragging="true" Visible="false" IsModal="true" Width="600px" ShowCloseIcon="true"
          Header="تنظیم کلمه عبور کاربر" CloseOnEscape="true">
    <DialogTemplates>
        <Content>
            <MudGrid>
                <MudItem>
                    <MudTextField Label="کلمه عبور:" @bind-Value="@_newPass" InputType="InputType.Password" />
                </MudItem>
                <MudItem>
                    <MudTextField Label="تکرار کلمه عبور:" @bind-Value="@_confPass" InputType="InputType.Password" />
                </MudItem>
            </MudGrid>
        </Content>
        <FooterTemplate>
            <MudButton Color="Color.Success" StartIcon="fas fa-check" Variant="Variant.Filled" OnClick="PassOkBtnClick">تأیید</MudButton>
        </FooterTemplate>
    </DialogTemplates>
    <DialogPositionData Y="top" />
    <DialogAnimationSettings Effect="DialogEffect.FadeZoom" />
</SfDialog>

<SfDialog @ref="PermitModal" AllowDragging="true" Visible="false" IsModal="true" Width="600px" ShowCloseIcon="true"
          Header="سطح دسترسی" CloseOnEscape="true">
    <DialogTemplates>
        <Content>
            <MudAlert Variant="Variant.Filled" Severity="Severity.Info">فقط در صورتی که می‌خواهید به یک کاربر اجازه دسترسی به اطلاعات چند دکل را بدهید از این قسمت استفاده کنید. دقت کنید که کاربر همواره به اطلاعات دکل فعال خود دسترسی دارد.</MudAlert>
            <SamcoRigSelector @bind-SelectedRigs="PermitRigList" IsMultiselect="true" DataSource="Rigs"/>
        </Content>
        <FooterTemplate>
            <MudButton Color="Color.Success" StartIcon="fas fa-check" Variant="Variant.Filled" OnClick="PermitOkBtnClick">تأیید</MudButton>
        </FooterTemplate>
    </DialogTemplates>
    <DialogPositionData Y="top" />
    <DialogAnimationSettings Effect="DialogEffect.FadeZoom" />
</SfDialog>

<SfDialog @ref="UpgradeModal" AllowDragging="true" Visible="false" IsModal="true" Width="600px" ShowCloseIcon="true"
          Header="به روز رسانی پرسنل" CloseOnEscape="true">
    <DialogTemplates>
        <Content>
            <MudAlert Variant="Variant.Filled" Severity="Severity.Info">در صورتی که می‌خواهید به پرسنل شرکت که قبلاً در سیستم ثبت کرده‌اید، دسترسی به سیستم دهید از این قسمت استفاده کنید.</MudAlert>
            <MudRTLProvider RightToLeft="true">
                <MudGrid>
                    <MudItem md="12">
                        <MudField Label="نام پرسنل:" Underline="false">
                            <SamcoPersonnelSelector @bind-SelectedPersonnel="_selPersonnel" DataSource="PersonnelList" Session="Session1" />
                        </MudField>
                    </MudItem>
                    <MudItem md="6" sm="12">
                        <MudTextField Label=":نام کاربری" @bind-Value="@_personnelUsername" Variant="Variant.Text"
                                      Placeholder="الزامی" Class="ltr" />
                    </MudItem>
                    <MudItem md="6" sm="12">
                        <MudField Label="نقش:" Underline="false">
                            <SfComboBox TItem="KeyValuePair<string, string>" TValue="string" DataSource="@_roles" Placeholder="الزامی"
                                        @bind-Value="@_personnelRole">
                                <ComboBoxFieldSettings Text="Value" Value="Key" />
                            </SfComboBox>
                        </MudField>
                    </MudItem>
                </MudGrid>
            </MudRTLProvider>
        </Content>
        <FooterTemplate>
            <MudButton Color="Color.Success" StartIcon="fas fa-check" Variant="Variant.Filled" OnClick="UpgradeOkBtnClick">تأیید</MudButton>
        </FooterTemplate>
    </DialogTemplates>
    <DialogPositionData Y="top" />
    <DialogAnimationSettings Effect="DialogEffect.FadeZoom" />
</SfDialog>